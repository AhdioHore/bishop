function doScan(e){var n=stripTrailingSlash(window.location.href);if(config.exclusionList.length>0)for(var t=config.exclusionList.split("::"),r=0;r<t.length;r++)if(n.indexOf(t[r])>-1&&t[r].length>0)return;if(e)for(;-1!=n;)scanURL(n),n=nextParent(n);else scanURL(n)}function scanURL(e){for(var n=0;n<rules.length;n++){delay+=1e3*config.xhrDelay;var t=rules[n];t.enabled&&setTimeout(upAndMatch,delay,e+"/"+t.url,t.searchString,t.name)}}function addSiteAndAlert(e,n){var t;chrome.storage.sync.get(null,function(r){t=r.sites;for(var s=0;s<t.length;s++){var i=t[s];if(i.url==e&&i.rule==n)return}if(t.push({uid:Math.floor(99999999*Math.random()).toString(16),url:e,rule:n}),chrome.storage.sync.set({sites:t}),config.soundFound){var o=new Audio(chrome.extension.getURL("/audio/alert.mp3"));o.play()}if(config.alertFound&&setTimeout(function(){alert("&#9821; Bishop matched your rule "+n+" at "+e)},500),config.alertCSSFound){var a=document.createElement("link");a.rel="stylesheet",a.type="text/css",a.href=chrome.extension.getURL("css/alert.css"),(document.head||document.documentElement).appendChild(a),document.body.insertAdjacentHTML("afterBegin",'<div id="note">&#9821; Bishop matched your rule "'+n+'". (Refresh page to dismiss)</div>')}})}function nextParent(e){return stripTrailingSlash(e),e=e.substr(0,e.lastIndexOf("/")),e.length<9?-1:e}function upAndMatch(e,n,t){var r=new XMLHttpRequest,s=new RegExp(n);return r.open("GET",e,!1),r.send(),200==r.status?(s.test(r.responseText)&&addSiteAndAlert(e,t),!1):!1}function stripTrailingSlash(e){return"/"==e.substr(-1)?e.substr(0,e.length-1):e}var rules,config,delay=0;chrome.storage.sync.get(null,function(e){rules=e.rules,config=e.config,e.status&&doScan(config.recursive)});